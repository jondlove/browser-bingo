<!doctype html>
<html lang="en">
    <head>
        <meta charset=utf-8>
        <title>Quick Bingo</title>
    </head>
    <body>
        <div style="padding-bottom:1em;">
            <strong>Title</strong>
            <input type="text" id="bingoTitle" placeholder="Your Bingo Title">
        </div>
        <div>
            <p><strong>Bingo Entries</strong></p>
            <p>Add one item per line</p>
            <p>Group items together with "---"</p>
        </div>

<textarea id="bingoLines" style="height:25em; width:50%;">
Regular Option
Another Option
---
Group A Option 1
Group A Option 2
---
Group B Option 1
Group B Option 2
Group B Option 3
</textarea>
        <div style="padding-bottom:1em;">
            <strong>Free Space Image:</strong>
            <input type="file" id="freeSpaceImage" accept="image/*">
            <button id="clearFreeSpaceImage" onclick="document.getElementById('freeSpaceImage').value='';">Clear</button>
        </div>
        <div style="padding-bottom:1em;">
            <strong>Count (1-30):</strong>
            <input id="pageCount" type="number" min="1" max="30" value="10">
        </div>
<button id="generate" onclick="generate()">GENERATE</button>
<div style="page-break-after:always;"></div>
<div id="generatorTarget">

</div>
        <script>
            function generate() {
                // First, clear everything in the body _after_ generateFromHere
                document.getElementById('generatorTarget').innerHTML = '';
                
                console.log('Generating pages');
                var lines = document.getElementById('bingoLines').value.split('\n');
                var pageCount = document.getElementById('pageCount').value;
                var freeSpaceImage = document.getElementById('freeSpaceImage').files[0];

                // First process the bingo lines to split by use of "---"
                var bingoGroups = [];
                var currentGroup = [];
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i] === "---") {
                        bingoGroups.push(currentGroup);
                        currentGroup = [];
                    } else {
                        currentGroup.push(lines[i]);
                    }
                }
                // Push the last group
                bingoGroups.push(currentGroup);

                // The first group represents items we can use on any Bingo square
                // The other groups represent lines, from which we should select ONE
                // option to fill a square
                
                // Generate elements for a 5x5 table, except the center square should
                // either say 'free', or be the specified image
                for (var p = 0; p < pageCount; p++) {
                    // Shuffle the order of the lines in each of the bingo groups
                    for (var i = 0; i < bingoGroups.length; i++) {
                        shuffle(bingoGroups[i]);
                    }

                    // Generate a unique set of numbers up to 2/3 the size of bingoGroups.length
                    // representing random bingoGroups to draw from
                    var randomGroups = [];
                    for (let i = 0; i < bingoGroups.length; i++) {
                        var random = Math.floor(Math.random() * bingoGroups.length);
                        if (randomGroups.indexOf(random) === -1) {
                            randomGroups.push(random);
                        }
                    }
                    // Now extend the randomGroups array up to 25 elements and fill the remaining
                    // values with '0'
                    while (randomGroups.length < 25) {
                        randomGroups.push(0);
                    }
                    // Shuffle the randomGroups array
                    shuffle(randomGroups);

                    var page = document.createElement('div');
                    page.style = 'page-break-after:always;';
                    // insert a horizontally centered h1 element saying "TUFF Bingo"
                    var h1 = document.createElement('h1');
                    h1.innerText = document.getElementById('bingoTitle').value || 'Bingo';
                    h1.style = 'text-align:center;';
                    page.appendChild(h1);
                    var table = document.createElement('table');
                    // Set the table to be 90vh and width 90vw to ensure it fits on the print page
                    table.style = 'height:90vh; width:90vw; margin:auto;';
                    

                    for (var i = 0; i < 5; i++) {
                        var row = document.createElement('tr');
                        for (var j = 0; j < 5; j++) {
                            var cell = document.createElement('td');
                            cell.style = 'border:1px solid black; text-align:center; vertical-align:middle; width:18vh; height:18vh;';
                            if (i === 2 && j === 2) {
                                if (freeSpaceImage) {
                                    var img = document.createElement('img');
                                    img.src = URL.createObjectURL(freeSpaceImage);
                                    img.style = 'max-width:100%; max-height:100%;';
                                    cell.appendChild(img);
                                } else {
                                    cell.innerHTML = '<strong>FREE</strong>';
                                }
                            } else {                                
                                // Iterate to the next element of the randomGroups array
                                // and select the first element from that bingoGroup
                                // moving it to the bottom of that bingoGroup
                                var groupIndex = randomGroups[i * 5 + j];
                                var item = bingoGroups[groupIndex][0];
                                bingoGroups[groupIndex].push(bingoGroups[groupIndex].shift());
                                cell.innerText = item;
                            }
                            row.appendChild(cell);
                        }
                        table.appendChild(row);
                    }
                    page.appendChild(table);
                    document.getElementById('generatorTarget').appendChild(page);
                }

                
            }
            // In-place shuffle the order of elements within an array
            function shuffle(array) {
                let currentIndex = array.length;

                // While there remain elements to shuffle...
                while (currentIndex != 0) {

                    // Pick a remaining element...
                    let randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;

                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
                }
                return array;
            }
        </script>
    </body>
</html>